<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Delete One Part</title>
    
    <!-- FONT AWESOME CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- CSS STYLES --- */

        /* 1. Global & Root Styles */
        :root {
            --primary-bg: #f4f4f9;
            --primary-card-bg: #ffffff;
            --primary-text: #2c3e50;
            --secondary-text: #7f8c8d;
            --accent-color: #3498db;
            --dark-accent-color: #2980b9;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --toolbar-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --splash-bg-start: #3a7bd5;
            --splash-bg-end: #00d2ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px; /* Simulates mobile device width */
            margin: 0 auto;
            background-color: var(--primary-card-bg);
            box-shadow: 0 0 20px var(--shadow-color);
            overflow: hidden;
        }

        /* 2. Screen Management */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 1;
            transform: scale(1);
            backface-visibility: hidden;
        }

        .screen.hidden {
            opacity: 0;
            transform: scale(1.05);
            pointer-events: none;
        }

        /* 3. Splash Screen */
        #splash-screen {
            background: linear-gradient(45deg, var(--splash-bg-start), var(--splash-bg-end));
            color: white;
            z-index: 100;
        }
        #splash-logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        #splash-tagline {
            font-size: 1rem;
            opacity: 0.8;
        }

        /* 4. Home Screen */
        #home-screen {
            justify-content: center;
            padding: 20px;
        }
        #home-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 40px;
        }
        .play-button {
            padding: 15px 60px;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            transition: background-color 0.3s, transform 0.2s;
        }
        .play-button:active {
            background-color: var(--dark-accent-color);
            transform: scale(0.95);
        }
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            width: 50px;
            height: 50px;
            line-height: 50px;
            text-align: center;
            background: var(--primary-bg);
            color: var(--secondary-text);
            border-radius: 50%;
            cursor: pointer;
        }

        /* 5. Game Screen */
        #game-screen {
            justify-content: flex-start;
            background-color: var(--primary-bg);
        }

        /* App Bar (Toolbar) */
        .app-bar {
            width: 100%;
            height: 60px;
            background-color: var(--toolbar-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-shadow: 0 2px 4px var(--shadow-color);
            flex-shrink: 0;
        }
        .app-bar-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .app-bar-icon {
            font-size: 1.4rem;
            width: 44px;
            height: 44px;
            line-height: 44px;
            text-align: center;
            color: var(--primary-text);
            cursor: pointer;
        }

        /* Canvas Area */
        #canvas-container {
            position: relative;
            width: 90%;
            margin: 20px 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px var(--shadow-color);
            aspect-ratio: 1 / 1; /* Make it a square, adjustable */
            touch-action: none; /* Prevents scrolling while drawing */
        }
        .game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #bottom-canvas { z-index: 1; }
        #top-canvas { z-index: 2; cursor: crosshair; }

        /* Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* 6. Popups / Dialogs */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .popup-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .popup-card {
            background-color: var(--primary-card-bg);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            width: 80%;
            max-width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .popup-overlay.visible .popup-card {
            transform: scale(1);
        }

        .popup-icon {
            font-size: 3rem;
            color: var(--success-color);
            margin-bottom: 15px;
        }
        .popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .popup-message {
            font-size: 1rem;
            color: var(--secondary-text);
            margin-bottom: 25px;
        }
        .popup-button {
            padding: 12px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .popup-button:active {
            background-color: var(--dark-accent-color);
        }
        #try-again-popup .popup-icon {
            color: var(--error-color);
        }

        /* 7. Ad Placeholders */
        #banner-ad-placeholder {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            z-index: 40;
        }

        #interstitial-ad-placeholder {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            z-index: 101;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #interstitial-ad-placeholder.hidden {
            display: none;
        }
        #interstitial-ad-placeholder p {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        #close-interstitial-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            border: 2px solid white;
            width: 40px;
            height: 40px;
            line-height: 38px;
            text-align: center;
            border-radius: 50%;
        }

    </style>
</head>
<body>

    <div id="app-container">
        <!-- =========== SCREENS =========== -->
        
        <!-- Splash Screen -->
        <div id="splash-screen" class="screen">
            <div id="splash-logo">DOP Game</div>
            <div id="splash-tagline">Delete One Part</div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="screen hidden">
            <h1 id="home-title">Ready to Play?</h1>
            <button id="play-game-btn" class="play-button">PLAY</button>
            <div id="sound-toggle-btn" class="sound-toggle">
                <i class="fas fa-volume-up"></i>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <div class="app-bar">
                <div id="retry-btn" class="app-bar-icon"><i class="fas fa-redo"></i></div>
                <div class="app-bar-title" id="level-title">Level 1</div>
                <div id="hint-btn" class="app-bar-icon"><i class="fas fa-lightbulb"></i></div>
            </div>

            <div id="canvas-container">
                <canvas id="bottom-canvas" class="game-canvas"></canvas>
                <canvas id="top-canvas" class="game-canvas"></canvas>
            </div>
            
             <!-- Banner Ad Placeholder -->
            <div id="banner-ad-placeholder">Banner Ad Placeholder</div>
        </div>

        <!-- =========== POPUPS =========== -->

        <!-- Level Complete Popup -->
        <div id="level-complete-popup" class="popup-overlay">
            <div class="popup-card">
                <div class="popup-icon"><i class="fas fa-check-circle"></i></div>
                <h2 class="popup-title">Level Complete!</h2>
                <p class="popup-message">You are a puzzle master!</p>
                <button id="next-level-btn" class="popup-button">Next Level</button>
            </div>
        </div>

        <!-- Try Again Popup -->
        <div id="try-again-popup" class="popup-overlay">
            <div class="popup-card">
                <div class="popup-icon"><i class="fas fa-times-circle"></i></div>
                <h2 class="popup-title">Not Quite!</h2>
                <p class="popup-message">That's not the right part. Try again!</p>
                <button id="try-again-btn" class="popup-button">Try Again</button>
            </div>
        </div>

         <!-- Hint Popup -->
         <div id="hint-popup" class="popup-overlay">
            <div class="popup-card">
                <div class="popup-icon"><i class="fas fa-lightbulb" style="color: #f1c40f;"></i></div>
                <h2 class="popup-title">Here's a Hint!</h2>
                <p class="popup-message" id="hint-text-content">Hint text will appear here.</p>
                <button id="close-hint-btn" class="popup-button">Got it!</button>
            </div>
        </div>

        <!-- =========== ADS =========== -->

        <!-- Interstitial Ad Placeholder -->
        <div id="interstitial-ad-placeholder" class="hidden">
            <div id="close-interstitial-btn">&times;</div>
            <p>Interstitial Ad Placeholder</p>
            <small>This would be a full-screen ad.</small>
        </div>
    </div>

    <script>
    // --- JAVASCRIPT LOGIC ---

    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. DOM ELEMENTS & CONSTANTS ---
        const DOMElements = {
            splashScreen: document.getElementById('splash-screen'),
            homeScreen: document.getElementById('home-screen'),
            gameScreen: document.getElementById('game-screen'),
            playBtn: document.getElementById('play-game-btn'),
            soundToggleBtn: document.getElementById('sound-toggle-btn'),
            levelTitle: document.getElementById('level-title'),
            retryBtn: document.getElementById('retry-btn'),
            hintBtn: document.getElementById('hint-btn'),
            canvasContainer: document.getElementById('canvas-container'),
            topCanvas: document.getElementById('top-canvas'),
            bottomCanvas: document.getElementById('bottom-canvas'),
            levelCompletePopup: document.getElementById('level-complete-popup'),
            nextLevelBtn: document.getElementById('next-level-btn'),
            tryAgainPopup: document.getElementById('try-again-popup'),
            tryAgainBtn: document.getElementById('try-again-btn'),
            hintPopup: document.getElementById('hint-popup'),
            hintText: document.getElementById('hint-text-content'),
            closeHintBtn: document.getElementById('close-hint-btn'),
            interstitialAd: document.getElementById('interstitial-ad-placeholder'),
            closeInterstitialBtn: document.getElementById('close-interstitial-btn'),
        };

        const topCtx = DOMElements.topCanvas.getContext('2d');
        const bottomCtx = DOMElements.bottomCanvas.getContext('2d');
        
        const ERASE_RADIUS = 25;
        const WIN_PERCENTAGE = 0.5; // 50% of the target area must be cleared
        const INTERSTITIAL_AD_INTERVAL = 3; // Show ad every 3 levels

        // --- 2. GAME STATE ---
        const gameState = {
            currentLevel: 0,
            soundEnabled: true,
            isDrawing: false,
            levels: [],
            vibrationEnabled: 'vibrate' in navigator,
        };

        // --- 3. LEVEL DATA ---
        // IMPORTANT: In a real game, these would be image URLs.
        // For this offline, single-file demo, we will generate images dynamically on the canvas.
        // This demonstrates the core logic without needing external files.
        const levels = [
            {
                id: 1,
                hint: "A house needs light to feel like a home.",
                targetArea: { x: 180, y: 150, width: 40, height: 40 }, // Approx area of the window
                draw: (puzzleCtx, solvedCtx) => {
                    // Solved state (bottom canvas)
                    solvedCtx.fillStyle = '#87CEEB'; // Sky
                    solvedCtx.fillRect(0, 0, 400, 400);
                    solvedCtx.fillStyle = '#2ecc71'; // Ground
                    solvedCtx.fillRect(0, 300, 400, 100);
                    solvedCtx.fillStyle = '#e74c3c'; // House
                    solvedCtx.fillRect(100, 150, 200, 150);
                    solvedCtx.beginPath(); // Roof
                    solvedCtx.moveTo(80, 150);
                    solvedCtx.lineTo(320, 150);
                    solvedCtx.lineTo(200, 80);
                    solvedCtx.closePath();
                    solvedCtx.fillStyle = '#8e44ad';
                    solvedCtx.fill();
                    solvedCtx.fillStyle = 'yellow'; // Light in window
                    solvedCtx.fillRect(180, 180, 40, 40);

                    // Puzzle state (top canvas)
                    puzzleCtx.drawImage(solvedCtx.canvas, 0, 0);
                    puzzleCtx.fillStyle = '#34495e'; // Dark window
                    puzzleCtx.fillRect(180, 180, 40, 40);
                }
            },
            {
                id: 2,
                hint: "What makes a smiley face happy?",
                targetArea: { x: 150, y: 220, width: 100, height: 40 }, // Area for the smile
                draw: (puzzleCtx, solvedCtx) => {
                    // Solved state
                    solvedCtx.fillStyle = 'yellow';
                    solvedCtx.beginPath();
                    solvedCtx.arc(200, 200, 150, 0, Math.PI * 2);
                    solvedCtx.fill();
                    solvedCtx.fillStyle = 'black';
                    solvedCtx.beginPath(); // Eyes
                    solvedCtx.arc(150, 150, 20, 0, Math.PI * 2);
                    solvedCtx.arc(250, 150, 20, 0, Math.PI * 2);
                    solvedCtx.fill();
                    solvedCtx.beginPath(); // Smile
                    solvedCtx.arc(200, 220, 80, 0, Math.PI, false);
                    solvedCtx.lineWidth = 10;
                    solvedCtx.stroke();
                    
                    // Puzzle state
                    puzzleCtx.drawImage(solvedCtx.canvas, 0, 0);
                    puzzleCtx.beginPath(); // Remove smile
                    puzzleCtx.arc(200, 220, 85, 0, Math.PI, false);
                    puzzleCtx.fillStyle = 'yellow';
                    puzzleCtx.fill();
                }
            },
             {
                id: 3,
                hint: "This car can't go anywhere without its wheels.",
                targetArea: { x: 260, y: 250, width: 70, height: 70 }, // Missing wheel
                draw: (puzzleCtx, solvedCtx) => {
                    // Solved state
                    solvedCtx.fillStyle = '#87CEEB'; // Sky
                    solvedCtx.fillRect(0, 0, 400, 400);
                    solvedCtx.fillStyle = '#7f8c8d'; // Road
                    solvedCtx.fillRect(0, 300, 400, 100);
                    solvedCtx.fillStyle = '#3498db'; // Car body
                    solvedCtx.fillRect(100, 200, 200, 50);
                    solvedCtx.fillRect(150, 150, 100, 50);
                    solvedCtx.fillStyle = 'black'; // Wheels
                    solvedCtx.beginPath();
                    solvedCtx.arc(140, 275, 25, 0, 2 * Math.PI);
                    solvedCtx.arc(280, 275, 25, 0, 2 * Math.PI);
                    solvedCtx.fill();
                    
                    // Puzzle state
                    puzzleCtx.drawImage(solvedCtx.canvas, 0, 0);
                    puzzleCtx.fillStyle = '#7f8c8d'; // Cover missing wheel with road color
                    puzzleCtx.beginPath();
                    puzzleCtx.arc(280, 275, 30, 0, 2 * Math.PI);
                    puzzleCtx.fill();
                }
            },
        ];
        gameState.levels = levels;


        // --- 4. CORE GAME LOGIC ---

        function loadLevel(levelIndex) {
            if (levelIndex >= gameState.levels.length) {
                // Game complete logic (e.g., show a final screen or loop)
                alert("Congratulations! You've completed all levels!");
                levelIndex = 0; // Loop back to the first level
            }
            gameState.currentLevel = levelIndex;
            localStorage.setItem('dop_currentLevel', gameState.currentLevel);

            const level = gameState.levels[levelIndex];
            DOMElements.levelTitle.textContent = `Level ${level.id}`;

            // Set canvas size based on container
            const canvasSize = DOMElements.canvasContainer.clientWidth;
            DOMElements.topCanvas.width = DOMElements.topCanvas.height = canvasSize;
            DOMElements.bottomCanvas.width = DOMElements.bottomCanvas.height = canvasSize;
            
            // The drawing functions assume a 400x400 canvas. We scale the context to match.
            const scale = canvasSize / 400;
            topCtx.setTransform(scale, 0, 0, scale, 0, 0);
            bottomCtx.setTransform(scale, 0, 0, scale, 0, 0);

            // Clear canvases
            topCtx.clearRect(0, 0, 400, 400);
            bottomCtx.clearRect(0, 0, 400, 400);

            // Draw the level
            level.draw(topCtx, bottomCtx);
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            gameState.isDrawing = true;
            draw(e); // Draw a single point on click/tap
        }

        function stopDrawing() {
            if (!gameState.isDrawing) return;
            gameState.isDrawing = false;
            topCtx.beginPath(); // End the current path
            checkWinCondition();
        }

        function draw(e) {
            if (!gameState.isDrawing) return;
            e.preventDefault();

            const pos = getMousePos(DOMElements.topCanvas, e);
            const canvasScale = DOMElements.topCanvas.width / 400; // Get the scale factor

            // Use globalCompositeOperation to "erase"
            topCtx.globalCompositeOperation = 'destination-out';
            topCtx.beginPath();
            topCtx.arc(pos.x / canvasScale, pos.y / canvasScale, ERASE_RADIUS, 0, Math.PI * 2, false);
            topCtx.fill();
        }

        function checkWinCondition() {
            const level = gameState.levels[gameState.currentLevel];
            const target = level.targetArea;
            
            // Get the pixel data from the erased canvas within the target area
            // We must account for the canvas scaling
            const canvasScale = DOMElements.topCanvas.width / 400;
            const scaledTarget = {
                x: target.x * canvasScale,
                y: target.y * canvasScale,
                width: target.width * canvasScale,
                height: target.height * canvasScale,
            };

            const imageData = topCtx.getImageData(scaledTarget.x, scaledTarget.y, scaledTarget.width, scaledTarget.height);
            const pixelData = imageData.data;
            
            let transparentPixels = 0;
            // Loop through the pixels (RGBA, so 4 values per pixel)
            for (let i = 3; i < pixelData.length; i += 4) {
                if (pixelData[i] === 0) { // Alpha channel is 0 (fully transparent)
                    transparentPixels++;
                }
            }

            const totalPixels = scaledTarget.width * scaledTarget.height;
            const transparentPercentage = transparentPixels / totalPixels;

            if (transparentPercentage >= WIN_PERCENTAGE) {
                handleWin();
            } else {
                // Optional: Implement a "wrong erase" check here if needed
                // For this version, we only check for a win, not a loss on every stroke.
            }
        }
        
        function handleWin() {
            playSound('win');
            vibrate(100);
            DOMElements.levelCompletePopup.classList.add('visible');
        }

        function handleWrongErase() {
            playSound('lose');
            vibrate([50, 50, 50]);
            DOMElements.canvasContainer.classList.add('shake');
            DOMElements.tryAgainPopup.classList.add('visible');
            
            setTimeout(() => {
                DOMElements.canvasContainer.classList.remove('shake');
            }, 500);
        }


        // --- 5. UI & EVENT HANDLERS ---
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function setupEventListeners() {
            DOMElements.playBtn.addEventListener('click', () => {
                showScreen('game-screen');
                loadLevel(gameState.currentLevel);
            });

            // Canvas listeners
            DOMElements.topCanvas.addEventListener('mousedown', startDrawing);
            DOMElements.topCanvas.addEventListener('mouseup', stopDrawing);
            DOMElements.topCanvas.addEventListener('mousemove', draw);
            DOMElements.topCanvas.addEventListener('mouseleave', stopDrawing);

            DOMElements.topCanvas.addEventListener('touchstart', startDrawing, { passive: false });
            DOMElements.topCanvas.addEventListener('touchend', stopDrawing);
            DOMElements.topCanvas.addEventListener('touchmove', draw, { passive: false });
            DOMElements.topCanvas.addEventListener('touchcancel', stopDrawing);

            // Popup buttons
            DOMElements.nextLevelBtn.addEventListener('click', () => {
                DOMElements.levelCompletePopup.classList.remove('visible');
                const nextLevelIndex = gameState.currentLevel + 1;

                // Check for interstitial ad
                if (nextLevelIndex % INTERSTITIAL_AD_INTERVAL === 0 && nextLevelIndex > 0) {
                    showInterstitialAd(() => loadLevel(nextLevelIndex));
                } else {
                    loadLevel(nextLevelIndex);
                }
            });
            
            DOMElements.tryAgainBtn.addEventListener('click', () => {
                DOMElements.tryAgainPopup.classList.remove('visible');
                loadLevel(gameState.currentLevel); // Reload current level
            });
            
            DOMElements.retryBtn.addEventListener('click', () => {
                 loadLevel(gameState.currentLevel);
            });

            // Hint system
            DOMElements.hintBtn.addEventListener('click', () => {
                const hint = gameState.levels[gameState.currentLevel].hint;
                DOMElements.hintText.textContent = hint;
                DOMElements.hintPopup.classList.add('visible');
            });

            DOMElements.closeHintBtn.addEventListener('click', () => {
                DOMElements.hintPopup.classList.remove('visible');
            });
            
            // Sound toggle
            DOMElements.soundToggleBtn.addEventListener('click', toggleSound);

            // Ads
            DOMElements.closeInterstitialBtn.addEventListener('click', () => {
                DOMElements.interstitialAd.classList.add('hidden');
                if (window.interstitialAdCallback) {
                    window.interstitialAdCallback();
                    window.interstitialAdCallback = null;
                }
            });
        }
// --- 6. SOUND & VIBRATION ---

        // As we can't embed audio in a single HTML file without base64 encoding (which makes it huge),
        // we'll simulate sounds with the Web Audio API. This creates tiny, synthetic sounds.
        let audioCtx;
        function initAudio() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser.");
                }
            }
        }

        function playSound(type) {
            if (!gameState.soundEnabled || !audioCtx) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);

            switch (type) {
                case 'win':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                    gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
                    oscillator.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.2); // C6
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                    break;
                case 'lose':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.05);
                    oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                    break;
                case 'click':
                     oscillator.type = 'sine';
                     oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                     gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
                     gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                     break;
            }

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            const icon = DOMElements.soundToggleBtn.querySelector('i');
            if (gameState.soundEnabled) {
                icon.classList.remove('fa-volume-mute');
                icon.classList.add('fa-volume-up');
                initAudio(); // Initialize audio context on first enable
                playSound('click');
            } else {
                icon.classList.remove('fa-volume-up');
                icon.classList.add('fa-volume-mute');
            }
        }
        
        function vibrate(pattern) {
            if (gameState.vibrationEnabled) {
                navigator.vibrate(pattern);
            }
        }

        // --- 7. MONETIZATION (PLACEHOLDERS) ---

        function showInterstitialAd(callback) {
            DOMElements.interstitialAd.classList.remove('hidden');
            // In a real app, you would listen for an ad SDK callback.
            // Here, we'll just wait for the user to close it.
            window.interstitialAdCallback = callback;
        }


        // --- 8. INITIALIZATION ---

        function init() {
            // Add a global click listener for button sound effects
             document.body.addEventListener('click', (e) => {
                if (e.target.matches('button, .app-bar-icon')) {
                    playSound('click');
                    vibrate(20);
                }
            }, true);

            setupEventListeners();
            
            // Load progress
            const savedLevel = localStorage.getItem('dop_currentLevel');
            if (savedLevel) {
                gameState.currentLevel = parseInt(savedLevel, 10);
            }

            // Simulate app loading
            setTimeout(() => {
                DOMElements.splashScreen.classList.add('hidden');
                showScreen('home-screen');
            }, 1500);
        }

        init(); // Start the application
    });

    </script>
</body>
</html>```
